<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Untitled Document</title>
    <script src="https://d3js.org/d3.v3.js"></script>
    <style>
        body{
            background: #eee;
        }
    </style>
    <style>
        .axis path, .axis line{
            fill:none;
            stroke:black;
            shape-rendering:auto;
        }
        .axis text{
            font-size: 15px;
            fill:blue;
        }
        
        #tooltip{
          position: absolute;
          left: 20px; 
          top:  100px; 
          background: #fff;
          width: auto;
          height: auto;
          padding: 0px 10px;
          border-radius: 5px;
          box-shadow: 5px 5px 10px rgba(0,0,0,0.3);
        }
        #tooltip.hidden{
          display: none;
        } 
        div .top{
            float:left;  
            margin-left: 10px;
        }
        div .bottom{
            float:left;  
            margin-left: 10px;
        }
        div #svg{
            float:left;  
            margin-left: 10px;
        }
        div #buttonlist{
            float:left;  
            margin-left: 10px;
            width:300px;
            height: auto;
        }
        div #dropdownlist{
            float:left;  
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .btn-primary-spacing{
            margin-right: 5px;
            margin-bottom: 5px !important;
        }
    </style>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
</head>
<body>
    <div id="tooltip" class="hidden">
        <p><strong id="city">Hello</strong></p>
        <p id="industry">tool2p</p>
    </div>
    
    <div id="main">
       <div class="top">
           <div id="dropdownlist"></div>
       </div>
       <div class="bottom">
            <div id="svg"></div>
            <div id="buttonlist"></div>
       </div> 
    </div>
    <script>
        var width = 900;
        var height = 600;
        var padding = 120;
        
//        appendDiv("body", "main");
//        appendDiv("div #main", "svg");
//        appendDiv("div #main", "buttonlist");
//        appendDiv("div #main", "dropdownlist");
        
        var svgSelection = appendSVG("div #svg",width, height,"svg");
        appendElement("svg", "rect", "100%", "100%", "white");
        appendAxis("axisX");
        appendAxis("axisY");
        
        d3.csv("invoice.csv", function(dataSet){
           bind(dataSet);
           render(dataSet);
        
           var uniqueIndustryArray = getUniqueIndustryArray(dataSet);
           appendButton("div #buttonlist", dataSet, uniqueIndustryArray); 
           appendOption("div #dropdownlist", dataSet, uniqueIndustryArray);
        });
        
        function appendDiv(container, appendId)
        {
          d3.select(container).append("div")
            .attr({
                id:appendId
            });
        }
        
        function appendSVG(container, width, height, appendId){
            var svgSelection = d3.select(container).append("svg");
            svgSelection.attr({
                   width:width,
                   height:height,
                    id:appendId
              });
            
            return svgSelection;
        }
        
        function appendElement(container, element, width, height, fill){
            d3.select(container).append("g").append(element)
              .attr({
                width:width,
                height:height,
                fill:fill
            });
        }
        
        function appendAxis(id){
            svgSelection.append("g").attr("id",id);
        }
        
        function bind(dataSet){
            var selection = svgSelection.selectAll("circle")
                                        .data(dataSet);
            
            selection.enter().append("circle");
            selection.exit().remove();
        }
        
        function render(dataSet){
            var scale = getScale(dataSet);

            renderXAxis(scale.xScale);
            renderYAxis(scale.yScale);
            
            d3.selectAll("circle")
              .attr({
                      cx:function(item){return scale.xScale(new Date(item.date));},
                      cy:function(item){return scale.yScale(+item.number);},
                       r:function(item){return scale.rScale(+item.amount);},
                    fill:function(item,index){return scale.fScale(item.cid);}})
                .on("mouseover",function(item){
                    var cx = d3.select(this).attr("cx");
                    var cy = d3.select(this).attr("cy");

                    var tooltip = d3.select("#tooltip")
                                    .style({
                                        left:(+cx+15)+"px",
                                        top:(+cy+15)+"px"});

                    tooltip.select("#city").text(item.city);
                    tooltip.select("#industry").text(item.industry);

                    d3.select("#tooltip").classed("hidden",false);})
                .on("mouseout", function(data){
                    d3.select("#tooltip").classed("hidden",true)
                });    
            
        }
        
        function getScale(dataSet){
            var scale = {};
            scale.xScale = d3.time.scale()
                             .domain([new Date(d3.min(dataSet,function(item){return item.date;})), 
                                      new Date(d3.max(dataSet,function(item){return item.date;}))])
                            .range([padding, width-padding]);
            
            scale.yScale = d3.scale.linear()
                             .domain([0,d3.max(dataSet,function(item){return +item.number;})])
                             .range([height-padding, padding]);
            
            scale.rScale = d3.scale.linear()
                             .domain([d3.min(dataSet,function(item){return +item.amount;}),
                                      d3.max(dataSet,function(item){return +item.amount;})])
                             .range([5,30]);
            
            scale.fScale = d3.scale.category20();
            
            return scale;
        } 
        function renderXAxis(xScale){
            var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
            d3.select("g#axisX")
              .attr("class","axis")
              .attr("transform", "translate(0, "+(height - padding+15)+")")
              .call(xAxis);
        } 
        function renderYAxis(yScale){
            var yAxis = d3.svg.axis().scale(yScale).orient("left");
            d3.select("g#axisY")
              .attr("class","axis")
              .attr("transform", "translate("+(padding-12)+",0)")
              .call(yAxis);
        }
        
        function getUniqueIndustryArray(dataSet){
            var industryArray = dataSet.map(function(data){
                                          return data.industry;})
                                       .filter(function(data){
                                          return data != "";
                                });
            return unique(industryArray);
        }
        
        function unique(array){
            var tempArray =[];
            array.map(function(item){
                if(tempArray.indexOf(item)<0){
                    tempArray.push(item);
                }
            });
            
            return tempArray;
        }
        
        function appendButton(container,dataSet, industryArray){
            var selection = d3.select(container)
                              .selectAll("button")
                              .data(industryArray);
            
            selection.enter().append("button")
                             .attr({"class":"btn btn-sm btn-default btn-primary-spacing"})
                             .text(function(data){ return data;})
                             .on("click", function(data){update(dataSet, data);});
            
            selection .exit().remove();
        }
        function appendOption(container,dataSet, industryArray){
            var selection = d3.select(container).append("select")
                              .selectAll("option")
                              .data(industryArray);
            
            selection.enter().append("option")
                             .attr({ value:function(data){ return data;}})
                             .text(function(data){ return data;})
                             
            d3.select("select")
              .on("change", function(data){
                  var selectedValue= d3.select("select").property("value"); 
                  update(dataSet, selectedValue);
                });
            
            selection .exit().remove();
        }
        function update(dataSet, industryName){
            var newDataSet = dataSet.filter(function(data){
                return data.industry === industryName;
            });
            console.log(newDataSet);
            bind(newDataSet);
            render(newDataSet);

            d3.select("")
        }
    </script>
</body>
</html>